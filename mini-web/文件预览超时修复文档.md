# 文件预览超时问题修复文档

## 问题描述

在读取大文件内容时，后端会对大于8KB的文件使用分段传输（每段16KB），但前端存在以下问题：

1. **固定超时机制**：前端使用固定的30秒超时，对于大文件分段传输可能不够
2. **超时计时器未重置**：收到分段数据时没有重置超时计时器，导致可能在传输过程中就超时
3. **缺乏进度反馈**：用户无法看到分段接收的进度，体验不佳
4. **无法取消加载**：用户无法主动取消正在进行的文件加载

## 后端分段传输机制（无需修改）

后端实现正确，采用以下策略：
- 响应大于8KB时启用分段传输
- 每段16KB，分段间有50毫秒延迟防止网络拥塞
- 每段有10秒写入超时
- 发送`file_view_segment`类型消息

## 前端修复方案

### 1. 动态超时机制

```typescript
// 根据文件大小动态设置超时时间
const baseTimeout = 30000; // 基础30秒
const sizeTimeoutBonus = Math.min(fileSize / (1024 * 1024) * 10000, 300000 - baseTimeout); // 每MB增加10秒，最大5分钟
const totalTimeout = baseTimeout + sizeTimeoutBonus;

const resetTimeout = () => {
    if (timeoutId) clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
        // 超时处理
        setLoading(false);
        setLoadingProgress(null);
        setCancelling(false);
        message.error(`文件加载超时 (${Math.round(totalTimeout / 1000)}秒)`);
    }, totalTimeout);
};
```

### 2. 分段接收时重置超时

```typescript
} else if (data.type === 'file_view_segment' && data.data.requestId === requestId) {
    console.log('📄 处理文件查看分段响应:', data.data.segmentId, '/', data.data.totalSegments);
    
    // 重置超时计时器，表示还在接收数据
    resetTimeout();
    
    // 更新进度显示
    setLoadingProgress({
        current: segmentInfo.segments.size,
        total: segmentInfo.totalSegments
    });
}
```

### 3. 进度显示界面

```tsx
{loadingProgress && (
    <div>
        <div style={{ marginBottom: 8 }}>
            <Text type="secondary">
                正在接收分段数据：{loadingProgress.current} / {loadingProgress.total}
            </Text>
        </div>
        <div style={{ width: 300, margin: '0 auto' }}>
            <div style={{
                width: '100%',
                height: 6,
                backgroundColor: '#f0f0f0',
                borderRadius: 3,
                overflow: 'hidden'
            }}>
                <div style={{
                    width: `${(loadingProgress.current / loadingProgress.total) * 100}%`,
                    height: '100%',
                    backgroundColor: '#1677ff',
                    transition: 'width 0.3s ease'
                }} />
            </div>
        </div>
        <div style={{ marginTop: 8 }}>
            <Text type="secondary" style={{ fontSize: 12 }}>
                {Math.round((loadingProgress.current / loadingProgress.total) * 100)}%
            </Text>
        </div>
    </div>
)}
```

### 4. 取消加载功能

```typescript
const cancelFileLoading = useCallback(() => {
    console.log('📄 用户取消文件加载');
    setCancelling(true);
    setLoading(false);
    setLoadingProgress(null);
    setFileContent({
        type: 'error',
        content: '',
        error: '用户取消了文件加载'
    });
    message.info('已取消文件加载');
}, []);
```

## 修复效果

1. **自适应超时**：根据文件大小调整超时时间，避免大文件传输超时
2. **实时超时重置**：每收到一个分段就重置超时，确保传输过程不会超时
3. **进度可视化**：显示分段接收进度条和百分比
4. **用户控制**：提供取消按钮，用户可以主动停止加载

## 测试场景

1. **小文件（<8KB）**：直接传输，30秒超时
2. **中文件（8KB-1MB）**：分段传输，动态超时（最多40秒）
3. **大文件（>1MB）**：分段传输，动态超时（最多5分钟）
4. **网络较慢**：通过重置超时机制避免误判超时
5. **用户取消**：随时可以取消正在进行的文件加载

## 代码变更摘要

### 新增状态变量
- `loadingProgress`: 跟踪分段接收进度
- `cancelling`: 跟踪取消状态

### 修改函数
- `loadFileContent`: 实现动态超时和重置机制
- `renderFileContent`: 添加进度显示和取消按钮
- `handleFileViewResponse`: 在分段接收时重置超时

### 新增函数
- `cancelFileLoading`: 取消文件加载
- `resetTimeout`: 动态重置超时计时器

这个修复解决了大文件分段传输时前端提前超时的问题，提升了用户体验。 