# æ–‡ä»¶é¢„è§ˆè¶…æ—¶é—®é¢˜ä¿®å¤æ–‡æ¡£

## é—®é¢˜æè¿°

åœ¨è¯»å–å¤§æ–‡ä»¶å†…å®¹æ—¶ï¼Œåç«¯ä¼šå¯¹å¤§äº8KBçš„æ–‡ä»¶ä½¿ç”¨åˆ†æ®µä¼ è¾“ï¼ˆæ¯æ®µ16KBï¼‰ï¼Œä½†å‰ç«¯å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **å›ºå®šè¶…æ—¶æœºåˆ¶**ï¼šå‰ç«¯ä½¿ç”¨å›ºå®šçš„30ç§’è¶…æ—¶ï¼Œå¯¹äºå¤§æ–‡ä»¶åˆ†æ®µä¼ è¾“å¯èƒ½ä¸å¤Ÿ
2. **è¶…æ—¶è®¡æ—¶å™¨æœªé‡ç½®**ï¼šæ”¶åˆ°åˆ†æ®µæ•°æ®æ—¶æ²¡æœ‰é‡ç½®è¶…æ—¶è®¡æ—¶å™¨ï¼Œå¯¼è‡´å¯èƒ½åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­å°±è¶…æ—¶
3. **ç¼ºä¹è¿›åº¦åé¦ˆ**ï¼šç”¨æˆ·æ— æ³•çœ‹åˆ°åˆ†æ®µæ¥æ”¶çš„è¿›åº¦ï¼Œä½“éªŒä¸ä½³
4. **æ— æ³•å–æ¶ˆåŠ è½½**ï¼šç”¨æˆ·æ— æ³•ä¸»åŠ¨å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æ–‡ä»¶åŠ è½½

## åç«¯åˆ†æ®µä¼ è¾“æœºåˆ¶ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

åç«¯å®ç°æ­£ç¡®ï¼Œé‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š
- å“åº”å¤§äº8KBæ—¶å¯ç”¨åˆ†æ®µä¼ è¾“
- æ¯æ®µ16KBï¼Œåˆ†æ®µé—´æœ‰50æ¯«ç§’å»¶è¿Ÿé˜²æ­¢ç½‘ç»œæ‹¥å¡
- æ¯æ®µæœ‰10ç§’å†™å…¥è¶…æ—¶
- å‘é€`file_view_segment`ç±»å‹æ¶ˆæ¯

## å‰ç«¯ä¿®å¤æ–¹æ¡ˆ

### 1. åŠ¨æ€è¶…æ—¶æœºåˆ¶

```typescript
// æ ¹æ®æ–‡ä»¶å¤§å°åŠ¨æ€è®¾ç½®è¶…æ—¶æ—¶é—´
const baseTimeout = 30000; // åŸºç¡€30ç§’
const sizeTimeoutBonus = Math.min(fileSize / (1024 * 1024) * 10000, 300000 - baseTimeout); // æ¯MBå¢åŠ 10ç§’ï¼Œæœ€å¤§5åˆ†é’Ÿ
const totalTimeout = baseTimeout + sizeTimeoutBonus;

const resetTimeout = () => {
    if (timeoutId) clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
        // è¶…æ—¶å¤„ç†
        setLoading(false);
        setLoadingProgress(null);
        setCancelling(false);
        message.error(`æ–‡ä»¶åŠ è½½è¶…æ—¶ (${Math.round(totalTimeout / 1000)}ç§’)`);
    }, totalTimeout);
};
```

### 2. åˆ†æ®µæ¥æ”¶æ—¶é‡ç½®è¶…æ—¶

```typescript
} else if (data.type === 'file_view_segment' && data.data.requestId === requestId) {
    console.log('ğŸ“„ å¤„ç†æ–‡ä»¶æŸ¥çœ‹åˆ†æ®µå“åº”:', data.data.segmentId, '/', data.data.totalSegments);
    
    // é‡ç½®è¶…æ—¶è®¡æ—¶å™¨ï¼Œè¡¨ç¤ºè¿˜åœ¨æ¥æ”¶æ•°æ®
    resetTimeout();
    
    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
    setLoadingProgress({
        current: segmentInfo.segments.size,
        total: segmentInfo.totalSegments
    });
}
```

### 3. è¿›åº¦æ˜¾ç¤ºç•Œé¢

```tsx
{loadingProgress && (
    <div>
        <div style={{ marginBottom: 8 }}>
            <Text type="secondary">
                æ­£åœ¨æ¥æ”¶åˆ†æ®µæ•°æ®ï¼š{loadingProgress.current} / {loadingProgress.total}
            </Text>
        </div>
        <div style={{ width: 300, margin: '0 auto' }}>
            <div style={{
                width: '100%',
                height: 6,
                backgroundColor: '#f0f0f0',
                borderRadius: 3,
                overflow: 'hidden'
            }}>
                <div style={{
                    width: `${(loadingProgress.current / loadingProgress.total) * 100}%`,
                    height: '100%',
                    backgroundColor: '#1677ff',
                    transition: 'width 0.3s ease'
                }} />
            </div>
        </div>
        <div style={{ marginTop: 8 }}>
            <Text type="secondary" style={{ fontSize: 12 }}>
                {Math.round((loadingProgress.current / loadingProgress.total) * 100)}%
            </Text>
        </div>
    </div>
)}
```

### 4. å–æ¶ˆåŠ è½½åŠŸèƒ½

```typescript
const cancelFileLoading = useCallback(() => {
    console.log('ğŸ“„ ç”¨æˆ·å–æ¶ˆæ–‡ä»¶åŠ è½½');
    setCancelling(true);
    setLoading(false);
    setLoadingProgress(null);
    setFileContent({
        type: 'error',
        content: '',
        error: 'ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶åŠ è½½'
    });
    message.info('å·²å–æ¶ˆæ–‡ä»¶åŠ è½½');
}, []);
```

## ä¿®å¤æ•ˆæœ

1. **è‡ªé€‚åº”è¶…æ—¶**ï¼šæ ¹æ®æ–‡ä»¶å¤§å°è°ƒæ•´è¶…æ—¶æ—¶é—´ï¼Œé¿å…å¤§æ–‡ä»¶ä¼ è¾“è¶…æ—¶
2. **å®æ—¶è¶…æ—¶é‡ç½®**ï¼šæ¯æ”¶åˆ°ä¸€ä¸ªåˆ†æ®µå°±é‡ç½®è¶…æ—¶ï¼Œç¡®ä¿ä¼ è¾“è¿‡ç¨‹ä¸ä¼šè¶…æ—¶
3. **è¿›åº¦å¯è§†åŒ–**ï¼šæ˜¾ç¤ºåˆ†æ®µæ¥æ”¶è¿›åº¦æ¡å’Œç™¾åˆ†æ¯”
4. **ç”¨æˆ·æ§åˆ¶**ï¼šæä¾›å–æ¶ˆæŒ‰é’®ï¼Œç”¨æˆ·å¯ä»¥ä¸»åŠ¨åœæ­¢åŠ è½½

## æµ‹è¯•åœºæ™¯

1. **å°æ–‡ä»¶ï¼ˆ<8KBï¼‰**ï¼šç›´æ¥ä¼ è¾“ï¼Œ30ç§’è¶…æ—¶
2. **ä¸­æ–‡ä»¶ï¼ˆ8KB-1MBï¼‰**ï¼šåˆ†æ®µä¼ è¾“ï¼ŒåŠ¨æ€è¶…æ—¶ï¼ˆæœ€å¤š40ç§’ï¼‰
3. **å¤§æ–‡ä»¶ï¼ˆ>1MBï¼‰**ï¼šåˆ†æ®µä¼ è¾“ï¼ŒåŠ¨æ€è¶…æ—¶ï¼ˆæœ€å¤š5åˆ†é’Ÿï¼‰
4. **ç½‘ç»œè¾ƒæ…¢**ï¼šé€šè¿‡é‡ç½®è¶…æ—¶æœºåˆ¶é¿å…è¯¯åˆ¤è¶…æ—¶
5. **ç”¨æˆ·å–æ¶ˆ**ï¼šéšæ—¶å¯ä»¥å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æ–‡ä»¶åŠ è½½

## ä»£ç å˜æ›´æ‘˜è¦

### æ–°å¢çŠ¶æ€å˜é‡
- `loadingProgress`: è·Ÿè¸ªåˆ†æ®µæ¥æ”¶è¿›åº¦
- `cancelling`: è·Ÿè¸ªå–æ¶ˆçŠ¶æ€

### ä¿®æ”¹å‡½æ•°
- `loadFileContent`: å®ç°åŠ¨æ€è¶…æ—¶å’Œé‡ç½®æœºåˆ¶
- `renderFileContent`: æ·»åŠ è¿›åº¦æ˜¾ç¤ºå’Œå–æ¶ˆæŒ‰é’®
- `handleFileViewResponse`: åœ¨åˆ†æ®µæ¥æ”¶æ—¶é‡ç½®è¶…æ—¶

### æ–°å¢å‡½æ•°
- `cancelFileLoading`: å–æ¶ˆæ–‡ä»¶åŠ è½½
- `resetTimeout`: åŠ¨æ€é‡ç½®è¶…æ—¶è®¡æ—¶å™¨

è¿™ä¸ªä¿®å¤è§£å†³äº†å¤§æ–‡ä»¶åˆ†æ®µä¼ è¾“æ—¶å‰ç«¯æå‰è¶…æ—¶çš„é—®é¢˜ï¼Œæå‡äº†ç”¨æˆ·ä½“éªŒã€‚ 