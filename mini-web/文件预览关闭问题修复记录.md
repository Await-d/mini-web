# æ–‡ä»¶é¢„è§ˆå…³é—­é—®é¢˜ä¿®å¤è®°å½•

## é—®é¢˜æè¿°

**é—®é¢˜ç°è±¡**ï¼šå½“ç”¨æˆ·æ‰“å¼€æ–‡ä»¶é¢„è§ˆåå…³é—­æ¨¡æ€æ¡†æ—¶ï¼Œå‰ç«¯ä»ç„¶ç»§ç»­æ¥æ”¶åç«¯å‘é€çš„æ–‡ä»¶æ•°æ®ï¼Œæ²¡æœ‰å‘é€åœæ­¢æŒ‡ä»¤ç»™åç«¯ã€‚

**å½±å“**ï¼š
- é€ æˆä¸å¿…è¦çš„ç½‘ç»œæµé‡
- æµªè´¹æœåŠ¡å™¨èµ„æº
- å¯èƒ½å½±å“åº”ç”¨æ€§èƒ½
- ç”¨æˆ·ä½“éªŒä¸ä½³

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
1. **å‰ç«¯çŠ¶æ€ç®¡ç†é—®é¢˜**ï¼šå…³é—­é¢„è§ˆæ—¶æ²¡æœ‰æ­£ç¡®é€šçŸ¥åç«¯åœæ­¢ä¼ è¾“
2. **ç›‘å¬å™¨æ¸…ç†é—®é¢˜**ï¼šWebSocketæ¶ˆæ¯ç›‘å¬å™¨æ²¡æœ‰è¢«æ­£ç¡®ç§»é™¤
3. **è¯·æ±‚IDç®¡ç†é—®é¢˜**ï¼šå½“å‰è¯·æ±‚IDå¯èƒ½æ²¡æœ‰è¢«æ­£ç¡®è®¾ç½®æˆ–æ¸…ç†

### æŠ€æœ¯ç»†èŠ‚
- æ–‡ä»¶é¢„è§ˆé€šè¿‡WebSocketåˆ†æ®µä¼ è¾“å®ç°
- åç«¯ä½¿ç”¨`sendSegmentedFileViewResponse`å‡½æ•°åˆ†æ®µå‘é€æ•°æ®
- å‰ç«¯ä½¿ç”¨`handleFileViewResponse`å‡½æ•°å¤„ç†æ¥æ”¶çš„æ•°æ®
- å–æ¶ˆæœºåˆ¶é€šè¿‡`file_view_cancel`æ¶ˆæ¯å®ç°

## ä¿®å¤å°è¯•å†å²

### ç¬¬ä¸€æ¬¡ä¿®å¤ (2024-01-XX)
**ä¿®å¤å†…å®¹**ï¼š
- åœ¨`FileViewer.tsx`çš„é‡ç½®çŠ¶æ€`useEffect`ä¸­æ·»åŠ `notifyBackendStopTransmission`è°ƒç”¨
- ç¡®ä¿åœ¨`visible`å˜ä¸º`false`æ—¶å‘é€å–æ¶ˆè¯·æ±‚

**ä¿®å¤ä»£ç **ï¼š
```typescript
useEffect(() => {
    if (!visible) {
        if (currentRequestRef.current) {
            notifyBackendStopTransmission(currentRequestRef.current, 'ç”¨æˆ·å…³é—­äº†é¢„è§ˆ');
        }
        // æ¸…ç†çŠ¶æ€...
    }
}, [visible, ...]);
```

**ç»“æœ**ï¼šé—®é¢˜ä»ç„¶å­˜åœ¨

### ç¬¬äºŒæ¬¡ä¿®å¤ (2024-01-XX)
**ä¿®å¤å†…å®¹**ï¼š
- åœ¨`loadFileContent`å‡½æ•°ä¸­æ­£ç¡®è®¾ç½®`currentRequestRef.current = requestId`
- åœ¨`cancelFileLoading`å‡½æ•°ä¸­æ·»åŠ åç«¯å–æ¶ˆé€šçŸ¥
- æ·»åŠ å¯¹`file_view_cancel_response`æ¶ˆæ¯çš„å¤„ç†
- åœ¨åˆ†æ®µæ•°æ®å¤„ç†å‰æ£€æŸ¥è¯·æ±‚æ˜¯å¦ä»ç„¶æœ‰æ•ˆ

**å…³é”®ä¿®å¤ç‚¹**ï¼š
```typescript
// 1. è®¾ç½®å½“å‰è¯·æ±‚ID
const requestId = `file_view_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
currentRequestRef.current = requestId;

// 2. å¤„ç†å–æ¶ˆå“åº”
} else if (data.type === 'file_view_cancel_response' && data.data.requestId === requestId) {
    console.log('ğŸ“„ æ”¶åˆ°å–æ¶ˆç¡®è®¤å“åº”:', data.data.reason);
    // æ¸…ç†çŠ¶æ€...

// 3. æ£€æŸ¥è¯·æ±‚æœ‰æ•ˆæ€§
if (currentRequestRef.current !== requestId) {
    console.log('ğŸ“„ å¿½ç•¥å·²å–æ¶ˆè¯·æ±‚çš„åˆ†æ®µæ•°æ®:', requestId);
    return;
}
```

**ç»“æœ**ï¼šé—®é¢˜ä»ç„¶å­˜åœ¨

### ç¬¬ä¸‰æ¬¡ä¿®å¤ (2024-01-XX)
**ä¿®å¤å†…å®¹**ï¼š
- æ·»åŠ `messageHandlerRef`ç”¨äºç®¡ç†WebSocketç›‘å¬å™¨å¼•ç”¨
- åˆ›å»º`clearMessageHandler`å‡½æ•°ç»Ÿä¸€æ¸…ç†ç›‘å¬å™¨
- åœ¨ç»„ä»¶å¸è½½æ—¶ä¹Ÿæ¸…ç†ç›‘å¬å™¨
- æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

**å…³é”®æ”¹è¿›**ï¼š
```typescript
// 1. æ¶ˆæ¯å¤„ç†å™¨å¼•ç”¨ç®¡ç†
const messageHandlerRef = useRef<((event: MessageEvent) => void) | null>(null);

// 2. ç»Ÿä¸€çš„ç›‘å¬å™¨æ¸…ç†
const clearMessageHandler = useCallback(() => {
    if (messageHandlerRef.current && webSocketRef.current) {
        webSocketRef.current.removeEventListener('message', messageHandlerRef.current);
        messageHandlerRef.current = null;
    }
}, [webSocketRef]);

// 3. ä¿å­˜ç›‘å¬å™¨å¼•ç”¨
messageHandlerRef.current = handleFileViewResponse;
webSocketRef.current.addEventListener('message', handleFileViewResponse);

// 4. é‡ç½®çŠ¶æ€æ—¶æ¸…ç†
if (!visible) {
    if (currentRequestRef.current) {
        notifyBackendStopTransmission(currentRequestRef.current, 'ç”¨æˆ·å…³é—­äº†é¢„è§ˆ');
    }
    clearMessageHandler();
    // å…¶ä»–æ¸…ç†...
}
```

**è°ƒè¯•åŠŸèƒ½**ï¼š
- æ·»åŠ è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—è¾“å‡º
- ç›‘æ§WebSocketè¿æ¥çŠ¶æ€
- è·Ÿè¸ªè¯·æ±‚IDè®¾ç½®å’Œæ¸…ç†
- ç›‘æ§ç›‘å¬å™¨æ·»åŠ å’Œç§»é™¤

**ç»“æœ**ï¼šé—®é¢˜ä»ç„¶å­˜åœ¨

### ç¬¬å››æ¬¡ä¿®å¤ (2024-01-XX)
**ä¿®å¤å†…å®¹**ï¼š
- æ·»åŠ å¼ºåˆ¶åœæ­¢æœºåˆ¶ï¼ˆ`forceStopRef` å’Œ `isProcessingRef`ï¼‰
- åˆ›å»ºç»Ÿä¸€çš„æ¸…ç†å‡½æ•° `forceStopAllProcessing`
- åœ¨æ¶ˆæ¯å¤„ç†å‡½æ•°å¼€å¤´æ·»åŠ å¼ºåˆ¶åœæ­¢æ£€æŸ¥
- åœ¨åˆ†æ®µå¤„ç†å’Œå¼‚æ­¥å¤„ç†ä¸­å¤šæ¬¡æ£€æŸ¥åœæ­¢æ ‡è®°
- ä¼˜åŒ–ç›‘å¬å™¨æ¸…ç†æ—¶æœºå’Œæ–¹å¼

**å…³é”®æ”¹è¿›**ï¼š
```typescript
// 1. å¼ºåˆ¶åœæ­¢æ§åˆ¶
const forceStopRef = useRef<boolean>(false);
const isProcessingRef = useRef<boolean>(false);

// 2. ç»Ÿä¸€æ¸…ç†å‡½æ•°
const forceStopAllProcessing = useCallback(() => {
    forceStopRef.current = true;
    isProcessingRef.current = false;
    // æ¸…ç†æ‰€æœ‰çŠ¶æ€å’Œç›‘å¬å™¨...
}, []);

// 3. æ¶ˆæ¯å¤„ç†å¼€å¤´æ£€æŸ¥
const handleFileViewResponse = (event: MessageEvent) => {
    if (forceStopRef.current) {
        console.log('ğŸ“„ æ”¶åˆ°æ¶ˆæ¯ä½†å·²å¼ºåˆ¶åœæ­¢ï¼Œå¿½ç•¥å¤„ç†');
        return;
    }
    // å¤„ç†æ¶ˆæ¯...
}

// 4. å…³é—­æ—¶ç«‹å³å¼ºåˆ¶åœæ­¢
if (!visible) {
    if (currentRequestRef.current && isProcessingRef.current) {
        notifyBackendStopTransmission(currentRequestRef.current, 'ç”¨æˆ·å…³é—­äº†é¢„è§ˆ');
    }
    forceStopAllProcessing();
    // é‡ç½®UIçŠ¶æ€...
}
```

**é˜²æŠ¤æœºåˆ¶**ï¼š
- åœ¨åˆ†æ®µå¤„ç†å‰æ£€æŸ¥ï¼š`if (currentRequestRef.current !== requestId || forceStopRef.current)`
- åœ¨å¼‚æ­¥å¤„ç†å®Œæˆåæ£€æŸ¥ï¼š`if (forceStopRef.current) { return; }`
- åœ¨æ‰€æœ‰æ¸…ç†ç‚¹è®¾ç½®å¤„ç†çŠ¶æ€æ ‡è®°

**æµ‹è¯•éªŒè¯**ï¼š
- åˆ›å»ºäº†è¯¦ç»†çš„æµ‹è¯•éªŒè¯æ–‡æ¡£
- æä¾›äº†å¤šä¸ªæµ‹è¯•åœºæ™¯å’ŒéªŒè¯æ ‡å‡†
- åŒ…å«è°ƒè¯•æç¤ºå’Œé—®é¢˜æ’æŸ¥æŒ‡å—

**é¢„æœŸç»“æœ**ï¼šå½»åº•è§£å†³å…³é—­é¢„è§ˆæ—¶åç«¯ç»§ç»­å‘é€æ•°æ®çš„é—®é¢˜

### ç¬¬äº”æ¬¡ä¿®å¤ (2024-01-XX) - å¢å¼ºç‰ˆ
**é—®é¢˜ç¡®è®¤**ï¼šæ¨¡æ€æ¡†å…³é—­åè¿˜æ˜¯æ²¡æœ‰æ­£å¸¸å‘é€åœæ­¢æŒ‡ä»¤

**æ–°å¢å¼ºåŒ–ä¿®å¤**ï¼š
- åœ¨`Modal`ç»„ä»¶çš„`onCancel`ä¸­ç›´æ¥å¤„ç†å…³é—­é€»è¾‘
- åˆ›å»ºç‹¬ç«‹çš„`handleModalClose`å‡½æ•°ï¼Œç¡®ä¿åœ¨æ¨¡æ€æ¡†è§¦å‘å…³é—­æ—¶ç«‹å³å¤„ç†
- å¢å¼ºè°ƒè¯•æ—¥å¿—ï¼ŒåŒ…å«æ›´è¯¦ç»†çš„WebSocketçŠ¶æ€ä¿¡æ¯
- ä¿®æ”¹ä¾èµ–æ£€æŸ¥é€»è¾‘ï¼Œåªè¦æœ‰`currentRequestRef.current`å°±å‘é€åœæ­¢æŒ‡ä»¤

**å…³é”®æ”¹è¿›**ï¼š
```typescript
// 1. æ¨¡æ€æ¡†ç›´æ¥å¤„ç†å…³é—­
const handleModalClose = useCallback(() => {
    console.log('ğŸ“„ ğŸšª æ¨¡æ€æ¡†onCancelè¢«è°ƒç”¨ - ç«‹å³å¤„ç†å…³é—­');
    handleClosePreview();
    onClose();
}, [handleClosePreview, onClose]);

// 2. å¢å¼ºçš„åœæ­¢ä¼ è¾“å‡½æ•°ï¼ˆè¯¦ç»†WebSocketçŠ¶æ€æ£€æŸ¥ï¼‰
const notifyBackendStopTransmission = useCallback((requestId: string, reason: string) => {
    console.log('ğŸ“„ âš ï¸ WebSocketè¯¦ç»†çŠ¶æ€æ£€æŸ¥:');
    console.log('ğŸ“„   - WebSocketå¯¹è±¡å­˜åœ¨:', !!webSocketRef.current);
    console.log('ğŸ“„   - WebSocket readyState:', webSocketRef.current?.readyState);
    console.log('ğŸ“„   - æ˜¯å¦ç›¸ç­‰:', webSocketRef.current?.readyState === WebSocket.OPEN);
    
    // è¿”å›å‘é€ç»“æœ
    return success;
}, [webSocketRef]);

// 3. ç®€åŒ–çš„å…³é—­æ¡ä»¶ï¼ˆåªæ£€æŸ¥requestIdå­˜åœ¨æ€§ï¼‰
if (currentRequestRef.current) {
    const success = notifyBackendStopTransmission(currentRequestRef.current, 'ç”¨æˆ·å…³é—­äº†é¢„è§ˆ');
}
```

**è°ƒè¯•ä¿¡æ¯å¢å¼º**ï¼š
- ä½¿ç”¨ğŸšªã€âš ï¸ã€âœ…ã€âŒç­‰å›¾æ ‡å¢å¼ºæ—¥å¿—å¯è¯»æ€§
- è¯¦ç»†è®°å½•WebSocketçŠ¶æ€æ£€æŸ¥è¿‡ç¨‹
- è¿”å›å‘é€ç»“æœä¾›è°ƒç”¨æ–¹ç¡®è®¤

**é¢„æœŸç»“æœ**ï¼šé€šè¿‡ç›´æ¥åœ¨æ¨¡æ€æ¡†äº‹ä»¶ä¸­å¤„ç†ï¼Œç¡®ä¿åœæ­¢æŒ‡ä»¤èƒ½å¤ŸåŠæ—¶å‘é€

## åç«¯å–æ¶ˆæœºåˆ¶éªŒè¯

**åç«¯å®ç°ç¡®è®¤**ï¼š
```go
// å–æ¶ˆè¯·æ±‚å¤„ç†
case "file_view_cancel":
    h.markRequestCancelled(requestData.RequestID)
    
// åˆ†æ®µä¼ è¾“ä¸­çš„å–æ¶ˆæ£€æŸ¥
func (h *ConnectionHandler) sendSegmentedFileViewResponse(...) {
    for i := 0; i < totalSegments; i++ {
        if h.isRequestCancelled(requestId) {
            // åœæ­¢ä¼ è¾“
            return
        }
        // å‘é€åˆ†æ®µ...
    }
}
```

**åç«¯æœºåˆ¶**ï¼šâœ… å·²ç¡®è®¤æ­£å¸¸å·¥ä½œ

## å½“å‰çŠ¶æ€

- ğŸ”„ ç¬¬äº”æ¬¡ä¿®å¤ï¼ˆå¢å¼ºç‰ˆï¼‰å·²å®Œæˆï¼Œç­‰å¾…æµ‹è¯•éªŒè¯
- âœ… å‰ç«¯å–æ¶ˆæœºåˆ¶å·²å®ç°ï¼ˆå¤šé‡é˜²æŠ¤ï¼‰
- âœ… åç«¯å–æ¶ˆæœºåˆ¶å·²ç¡®è®¤
- âœ… è°ƒè¯•æ—¥å¿—å·²æ·»åŠ ï¼ˆå¢å¼ºç‰ˆï¼‰
- âœ… å¼ºåˆ¶åœæ­¢æœºåˆ¶å·²å®ç°
- âœ… æ¨¡æ€æ¡†ç›´æ¥å…³é—­å¤„ç†å·²å®ç°
- â“ éœ€è¦æŒ‰ç…§æµ‹è¯•æ–‡æ¡£è¿›è¡ŒéªŒè¯ï¼Œé‡ç‚¹è§‚å¯ŸWebSocketçŠ¶æ€æ—¥å¿—

## ä¸‹ä¸€æ­¥è¯Šæ–­è®¡åˆ’

### éœ€è¦éªŒè¯çš„ç‚¹
1. **å‰ç«¯æ—¥å¿—æ£€æŸ¥**ï¼š
   - å…³é—­é¢„è§ˆæ—¶æ˜¯å¦æ˜¾ç¤º"ğŸ“„ å…³é—­é¢„è§ˆï¼Œé€šçŸ¥åç«¯åœæ­¢ä¼ è¾“"
   - æ˜¯å¦æ˜¾ç¤º"ğŸ“„ å‘é€åœæ­¢ä¼ è¾“è¯·æ±‚å·²å‘é€"
   - WebSocketè¿æ¥çŠ¶æ€æ˜¯å¦æ­£å¸¸

2. **åç«¯æ—¥å¿—æ£€æŸ¥**ï¼š
   - æ˜¯å¦æ¥æ”¶åˆ°`file_view_cancel`è¯·æ±‚
   - æ˜¯å¦æ­£ç¡®æ ‡è®°è¯·æ±‚ä¸ºå·²å–æ¶ˆ
   - åˆ†æ®µå¾ªç¯æ˜¯å¦æ£€æŸ¥åˆ°å–æ¶ˆçŠ¶æ€

3. **æ—¶åºé—®é¢˜**ï¼š
   - å–æ¶ˆè¯·æ±‚ä¸åˆ†æ®µä¼ è¾“çš„æ—¶åºå…³ç³»
   - ç›‘å¬å™¨ç§»é™¤ä¸æ¶ˆæ¯æ¥æ”¶çš„æ—¶åºå…³ç³»

### å¯èƒ½çš„é—®é¢˜æ–¹å‘
1. **ç½‘ç»œå»¶è¿Ÿ**ï¼šå–æ¶ˆè¯·æ±‚åˆ°è¾¾åç«¯æ—¶ï¼Œéƒ¨åˆ†åˆ†æ®µå¯èƒ½å·²ç»åœ¨ä¼ è¾“ä¸­
2. **å‰ç«¯çŠ¶æ€åŒæ­¥**ï¼šReactçŠ¶æ€æ›´æ–°çš„å¼‚æ­¥æ€§å¯èƒ½å¯¼è‡´æ—¶åºé—®é¢˜
3. **WebSocketç¼“å†²**ï¼šæµè§ˆå™¨æˆ–æœåŠ¡å™¨ç«¯å¯èƒ½æœ‰æ¶ˆæ¯ç¼“å†²
4. **ç›‘å¬å™¨ä½œç”¨åŸŸ**ï¼šå‡½æ•°ä½œç”¨åŸŸé—®é¢˜å¯¼è‡´ç›‘å¬å™¨æ— æ³•æ­£ç¡®ç§»é™¤

## ä¿®å¤æäº¤è®°å½•

- `fix(FileViewer): ä¿®å¤å…³é—­é¢„è§ˆæ—¶åç«¯ç»§ç»­å‘é€æ•°æ®çš„é—®é¢˜` - ç¬¬ä¸€æ¬¡ä¿®å¤å°è¯•
- `fix(FileViewer): å®Œå–„æ–‡ä»¶é¢„è§ˆå…³é—­æ—¶çš„ç›‘å¬å™¨æ¸…ç†æœºåˆ¶` - ç¬¬äºŒæ¬¡ä¿®å¤å°è¯•

## ç›¸å…³æ–‡ä»¶

- `mini-web/frontend/src/components/SimpleTerminal/FileViewer.tsx` - ä¸»è¦ä¿®å¤æ–‡ä»¶
- `mini-web/backend/internal/api/connection_handler.go` - åç«¯å–æ¶ˆæœºåˆ¶

---

**æœ€åæ›´æ–°**ï¼š2024-01-XX  
**çŠ¶æ€**ï¼šé—®é¢˜ä»åœ¨è°ƒæŸ¥ä¸­  
**è´Ÿè´£äºº**ï¼šå¼€å‘å›¢é˜Ÿ 