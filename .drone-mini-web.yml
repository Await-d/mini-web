kind: pipeline
type: docker
name: mini-web-deployment

steps:
  - name: build-and-deploy
    image: docker:dind
    volumes:
      - name: docker-socket
        path: /var/run/docker.sock
      - name: app-config
        path: /config
    commands:
      # 使用目录设置脚本确保目录结构
      - chmod +x scripts/setup-directories.sh
      - ./scripts/setup-directories.sh /volume1/docker/1panel/apps/local/mini-web
      # 构建并部署容器
      - docker build -t mini-web:latest .
      - docker stop mini-web-container || true
      - docker rm mini-web-container || true
      - >
        docker run -d --name mini-web-container 
        -p 8090:80
        -v /volume1/docker/1panel/apps/local/mini-web/data:/app/data
        -v /volume1/docker/1panel/apps/local/mini-web/logs:/app/logs
        -v /volume1/docker/1panel/apps/local/mini-web/configs:/app/configs
        -v /volume1/docker/1panel/apps/local/mini-web/screenshots:/tmp/rdp_screenshots
        --restart always
        mini-web:latest

volumes:
  - name: docker-socket
    host:
      path: /var/run/docker.sock
  - name: app-config
    host:
      path: /volume1/docker/1panel/apps/local/mini-web/configs

trigger:
  branch:
    - master  # 监听 master 分支